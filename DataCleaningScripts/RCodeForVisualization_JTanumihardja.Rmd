---
title: "IE6600 Team Project"
author: "Jessica Tanumihardja (Team Shabu Shabu)"
due date: "Due: April 10th, 2023 "
output:
  pdf_document: default
  html_notebook: default
---

Dataset: WHO/UNICEF Joint Monitoring Programme for Water Supply, Sanitation and Hygiene (JMP) has reported country, regional and global estimates of progress on drinking water, sanitation and hygiene (WASH) since 1990 https://washdata.org/data/downloads#WLD

```{r setup, include=FALSE}
# echo=T to show the code, eval=T to show the results ----
knitr::opts_chunk$set(echo = T, eval=T) 
# Pre-load packages ----
library(tidyverse) 
library(ggplot2)
library(datasets)
library(haven)
library(readxl)
#library(caret)


```

# Import the dataset

Use the original dataset downloaded from website: https://washdata.org/data/downloads#WLD 

```{r}
#use the original dataset downloaded from the website
file_path <- "C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/JMP_2021_WLD.xlsx"

```

## Water (TBD)

```{r, cache=TRUE}
water_raw <- read_excel(file_path, sheet = "Sanitation")
```

```{r , cache=TRUE}
water <- read_excel(file_path, sheet = "Water", skip =2)
```

### Rename columns

```{r}
column_names_water <- c(
  "COUNTRY",
  "ISO3",
  "YEAR",
  "POPULATION(THOUSANDS)",
  "%URBAN",
  "NATIONAL_AtLeastBasic",
  "NATIONAL_Limited(>30min)",
  "NATIONAL_Unimproved",
  "NATIONAL_SurfaceWater",
  "NATIONAL_AnnualRateOfChangeInBasic",
  "RURAL_AtLeastBasic",
  "RURAL_Limited(>30min)",
  "RURAL_Unimproved",
  "RURAL_SurfaceWater",
  "RURAL_AnnualRateOfChangeInBasic",
  "URBAN_AtLeastBasic",
  "URBAN_Limited(>30min)",
  "URBAN_Unimproved",
  "URBAN_SurfaceWater",
  "URBAN_AnnualRateOfChangeInBasic",
  "NATIONAL_SafelyManaged_SafelyManaged",
  "NATIONAL_SafelyManaged_AccessibleOnPremises",
  "NATIONAL_SafelyManaged_AvailableWhenNeeded",
  "NATIONAL_SafelyManaged_FreeFromContamination",
  "NATIONAL_SafelyManaged_AnnualRateOfChangeInSafelyManaged",
  "NATIONAL_FacilityType_Piped",
  "NATIONAL_FacilityType_NonPiped",
  "RURAL_SafelyManaged_SafelyManaged",
  "RURAL_SafelyManaged_AccessibleOnPremises",
  "RURAL_SafelyManaged_AvailableWhenNeeded",
  "RURAL_SafelyManaged_FreeFromContamination",
  "RURAL_SafelyManaged_AnnualRateOfChangeInSafelyManaged",
  "RURAL_FacilityType_Piped",
  "RURAL_FacilityType_NonPiped",
  "URBAN_SafelyManaged_SafelyManaged",
  "URBAN_SafelyManaged_AccessibleOnPremises",
  "URBAN_SafelyManaged_AvailableWhenNeeded",
  "URBAN_SafelyManaged_FreeFromContamination",
  "URBAN_SafelyManaged_AnnualRateOfChangeInSafelyManaged",
  "URBAN_FacilityType_Piped",
  "URBAN_FacilityType_NonPiped",
  "SI",
  "SDGRegion", 
  "WHORegion", 
  "UNICEFProgrammingRegion", 
  "UNICEFReportingRegion"
)

water <- water %>% rename_with(~column_names_water)
names(water)
#sapply(water, class)
```

### Tidying data

```{r}
#tidying
water <- water %>% select(-SI) #remove indexing

#replace "-" with NA
water <- water %>% 
  mutate_all(~ifelse(. == "-", NA, .)) 

#head(water)
```

### Set as numeric

```{r eval=FALSE}
#check index to change to numeric (6:41)
names(water)
```


```{r}
#clean non numeric
#remove < and > on numbers column index 6 to 17
  #which one is better? Do this or set <1 as 0.5? 
#hygiene_data[, 6:17] <- lapply(hygiene_data[, 6:17], function(x)
#  as.numeric(gsub("\\>|<","", as.character(x)))) #or "[^[:alnum:]]" or "[^[0-9]]" 

# For now, "<1" is replaced with 0.5, and ">99" is replaced with 99.5
water <- water %>% 
  mutate_all(~ifelse(. == "<1", 0.5, .)) 

water <- water %>% 
  mutate_all(~ifelse(. == ">99", 99.5, .))

#set as numeric
water <- water %>%
  mutate_at(6:41, as.numeric)

sapply(water, class)
```


### Divide to two df & Pivot Longer

Col 6:20 are one type of df, Col 21:41 are details of those df. So will separate into two df.

```{r}
### split into two df and pivot longer

#water overview
water1 <- water %>%
  select(c(1:5, 6:20, 42:45)) %>%
  pivot_longer(
    cols = NATIONAL_AtLeastBasic:URBAN_AnnualRateOfChangeInBasic,
    names_to = c("REGION", "ServiceLevel"),
    names_sep = "_",
    values_to = "Percentage")

#water details: Safely Managed Criteria and Facility Type
water2 <- water %>%
  select(c(1:5, 21:41, 42:45)) %>%
  pivot_longer(
    cols =  NATIONAL_SafelyManaged_SafelyManaged:URBAN_FacilityType_NonPiped,
    names_to = c("REGION", "SafelyManagedCriteria", "CriteriaDetails"),
    names_sep = "_",
    values_to = "Percentage")
```

```{r eval=FALSE}
names(water1)
```

```{r eval=FALSE}
names(water2)
```

Save df for future use
```{r eval=FALSE}
#if want to write the df in folder
#write.csv(water1, "C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/water1.csv", row.names=FALSE)

#write.csv(water2, "C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/water2.csv", row.names=FALSE)
```

### Load files directly

```{r}
df_water <- read_csv("C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/water1.csv")

df_water2 <- read_csv("C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/water2.csv")
```

```{r eval=FALSE}
#check columns
sapply(water2, class)
```


### Donut Plot - water

World summary:

```{r}
unique(water1$ServiceLevel)
```

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

df_water %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=ServiceLevel))+
    geom_text(aes(label = paste(round(median,2), " %")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
      # Set theme_void() to remove grid lines and everything else from the plot
   scale_fill_brewer(palette = "PuBuGn") + #set color pallete per dataset
    theme_void()
```


```{r eval=FALSE}
df_water %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           COUNTRY == "Zimbabwe") #%>% #remove NA to prepare for calculation below
  #group_by(ServiceLevel) %>% #combine all country
  #summarise(median = median(Percentage, na.rm=TRUE)) 
```


```{r}
library(ggiraph)

df_donut <- df_water %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage, na.rm=TRUE)) 

hsize <- 3

plot <- ggplot(df_donut, aes(x=hsize, y=median, fill=ServiceLevel))+
  geom_col_interactive(aes(tooltip = paste(ServiceLevel, ": ", round(median,2), "%")))+
  coord_polar(theta = "y")+ #convert bar chart to polar
  # Set the limits, which is important for adding the hole
  xlim(c(0.2, hsize + 0.5))+
  theme_void() +
  scale_fill_brewer(palette = "PuBuGn") +
  labs(title="world median dw")
  

girafe(ggobj = plot, options = c(opts_hover(css = "cursor:pointer;fill:red;stroke:red;")))
```


**Per country**

source: 

* https://r-graph-gallery.com/128-ring-or-donut-plot.html 
* https://r-charts.com/part-whole/donut-chart-ggplot2/ 
* https://stackoverflow.com/questions/45445904/weird-cumsum-not-working-on-dplyr 

```{r eval=FALSE}
df.plot <- df_water %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           COUNTRY == "Zimbabwe") %>%  #%in% c("Indonesia", "Japan", "China") & #facet wrap
           #remove NA to prepare for calculation below
  group_by(ServiceLevel, COUNTRY, YEAR) %>% #combine all country
  summarise(median = median(Percentage, na.rm = TRUE)) %>% 
  ungroup()

#add column to calculate the label position
df.plot <- df.plot %>% 
  arrange(-desc(median)) %>% 
  mutate(ymax = cumsum(median),
         ymin = c(0, head(ymax, n=-1)),
         labelPos = (ymin + ymax)/2#,
         #label = paste0(ServiceLevel, ": \n", round(median,2), "%")
         ) #%>% 

df.plot
```

```{r}
plot_c <- df.plot %>% 
  ggplot(aes(ymax = ymax, ymin = ymin, xmin = 2.5, xmax=4))+ 
    geom_rect(aes(fill=ServiceLevel))+
    #scale_y_reverse()+
    geom_text(x = 4, aes(y = labelPos,
                  label = paste0(ServiceLevel, ": \n", round(median,2), "%")),
                  size = 4)+ #,
                  #color = ServiceLevel)+ #reduce decimal on value
              #position = position_stack(vjust = 0.5))+#,
              #hjust = -0.75) +
    coord_polar(theta = "y")+ #convert bar chart to polar
    
      # Set the limits, which is important for adding the hole
    xlim(c(-1,4))+ #0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    scale_fill_brewer(palette = "PuBuGn") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    #facet_wrap(~COUNTRY)+
    theme_void()+
    labs(title = "Service Level Distribution Summary",
         subtitle = "Median Percentage of selected Country")+
    theme(legend.position = "none")

plot_c
```


```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

# df.plot <- df_water %>% 
#   filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
#            YEAR == 2020 &
#            REGION == "NATIONAL" &
#            COUNTRY == "Zimbabwe") %>%  #%in% c("Indonesia", "Japan", "China") & #facet wrap
#            #remove NA to prepare for calculation below
#   group_by(ServiceLevel, COUNTRY, YEAR) %>% #combine all country
#   summarise(median = median(Percentage, na.rm = TRUE)) %>%
#   ungroup() %>% 
#   mutate(cumsum = cumsum(median))
#add cummulative here for label

plot_c <- df.plot %>% 
  ggplot()+ 
    geom_col(aes(x=hsize, y=median, fill=ServiceLevel))+
    #scale_y_reverse()+
    geom_text(aes(x = hsize, y = labelPos, 
                  label = paste(round(median,2), "%")))+ #reduce decimal on value
              #position = position_stack(vjust = 0.5))+#,
              #hjust = -0.75) +
    coord_polar(theta = "y")+ #convert bar chart to polar
    
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    scale_fill_brewer(palette = "PuBuGn") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    #facet_wrap(~COUNTRY)+
    #theme_void()+
    labs(title = "Service Level Distribution Summary",
         subtitle = "Median Percentage of selected Country")

plot_c
```

```{r}
water1 %>% 
    group_by(ServiceLevel, COUNTRY) %>% #combine all country/selected 
    summarise(median = median(Percentage)) 
```


```{r}

plot_donut <- function(df){
  df.donut <- df %>% 
    group_by(ServiceLevel, COUNTRY, YEAR) %>% #combine all country/selected 
    summarise(median = median(Percentage)) 
}
```


**Per WHO Region**

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

water1 %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 & #how to deal with range?
           REGION == "NATIONAL" &
           WHORegion == "South-East Asia" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=ServiceLevel))+
    geom_text(aes(label = paste(round(median,2), "%")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    scale_fill_brewer(palette = "PuBuGn") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    theme_void()
```

### Lollipop for diverging and ranking

Diverging deviation for Annual Rate of Change in Basic:

```{r}
#per country
water1 %>% 
  filter(ServiceLevel == "AnnualRateOfChangeInBasic" &  
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  arrange(desc(Percentage)) %>% #highest first 
  head(20) %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_segment(aes(xend=COUNTRY, yend=0)) +
    geom_point(size=6, color="lightblue") +
    geom_text(aes(label=round(Percentage,1)), color="black", size=3)+
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %",
         title="Top 20 Countries")+
    coord_flip()
```

```{r}
#per country
water1 %>% 
  filter(ServiceLevel == "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  arrange(desc(Percentage)) %>% #highest first 
  tail(10) %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_segment(aes(xend=COUNTRY, yend=0)) +
    geom_point(size=6, color="lightblue") +
    geom_text(aes(label=round(Percentage,2)), color="black", size=3)+
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %",
         title="Bottom 10 countries")+
    coord_flip()
```

## Summary Chart

```{r}
unique(water1$ServiceLevel)
```


```{r}
#create summary df for the whole world "At Least Basic" level
  #can also do it for "AnnualRateOfChangeInBasic" for ALL dataset?
water_summary <- water1 %>% 
  filter(ServiceLevel == "AtLeastBasic" &
           REGION == "NATIONAL") %>% #can delete this if wanted to show difference
  group_by(YEAR, ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage, na.rm=TRUE))

sanitation_summary <- sanitation1 %>% 
  filter(ServiceLevel == "AtLeastBasic" &
           REGION == "NATIONAL") %>% 
  group_by(YEAR, ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage, na.rm=TRUE))

hygiene_summary <- hygiene1 %>% 
  filter(ServiceLevel == "Basic" &
           REGION == "NATIONAL") %>% 
  group_by(YEAR, ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage, na.rm=TRUE))
```

source: https://www.statology.org/merge-multiple-data-frames-in-r/

```{r}
#merge those datasets (put to list and merge all)
df_summary <- list(water_summary, sanitation_summary, hygiene_summary)

df_summary <- df_summary %>% reduce(full_join, by='YEAR')
```

Drop not useful columns and rename colnames

```{r}
df_summary <- df_summary %>% 
  select(YEAR, ServiceLevel.x, median.x, median.y, median)

names(df_summary) <- c("YEAR", "ServiceLevel", "Water", "Sanitation", "Hygiene")
df_summary
```

```{r}
#pivot longer
df_summary <- df_summary %>% 
  pivot_longer(
    cols = Water:Hygiene,
    names_to = "Dataset",
    values_to = "MedianPercentage")
```

Write `df_summary` in CSV for ease of data pulling:
```{r eval=FALSE}
#write.csv(df_summary, "C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/df_summary.csv", row.names=FALSE)
```

**ALL YEAR in range COMPARISON**

Should we show sum of population or percentage?

```{r}
#plot summary
df_summary %>% 
  filter(YEAR >= 2010 & YEAR <= 2020) %>% 
  ggplot(aes(x=YEAR, y=MedianPercentage)) + 
    geom_col(aes(fill=Dataset), position = "dodge") + 
    theme_bw() +
    scale_fill_brewer(palette = "Set2")+
    labs(title = "World Percentage of At Least Basic", 
         subtitle = "Median of All Countries Coverage Percentage",
         y = "Coverage Percentage")
```
**Two year 3 dataset comparison**

Can also add REGION difference in FACET_WRAP() if wanted

```{r}
#plot summary
df_summary %>% 
  filter(YEAR == 2000 | YEAR == 2020) %>% #can make this reactive
  mutate(YEAR = factor(YEAR)) %>% 
  ggplot(aes(x=YEAR, y=MedianPercentage)) + 
    geom_col(aes(fill=Dataset), position = "dodge", width=0.5) +
    theme_bw() +
    scale_fill_brewer(palette = "Set2")+
    labs(title = "Growth of World's 'At Least Basic' Service Level", 
         subtitle = "Median of All Countries Percentage",
         y = "Percentage (median)")
```

color palette: https://r-graph-gallery.com/38-rcolorbrewers-palettes.html

**Population Lacking of Basic Sanitation**

```{r}
#sanitation summary (can also make for water and hygiene)
sanitation1 %>% 
  filter(ServiceLevel %in% c("Limited(shared)", "Unimproved", "OpenDefecation") & 
           REGION == "NATIONAL") %>% 
  filter(YEAR == 2000 | YEAR == 2020) %>% 
  group_by(YEAR, ServiceLevel) %>% #combine all country
  summarise(popul = sum(Percentage/100 * `POPULATION(THOUSANDS)` /1000, #sum of all countries
                           na.rm=TRUE)) %>% #remove NA to maximize sample
  mutate(YEAR = factor(YEAR)) %>% 
  ggplot(aes(x=YEAR, y=popul))+
    geom_col(aes(fill=ServiceLevel), width = 0.5)+
    scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
    theme_bw()+
  labs(title="World Population Lacking of Basic Sanitation",
       subtitle = "REGION = NATIONAL",
       y = "Population (millions)")
```


---------------------------------------------------------------------------------


## SANITATION - PIVOT LONGER

```{r reload, cache=TRUE}
#load raw dataset to check
sanitation_raw <- read_excel(file_path, sheet = "Sanitation")

#head(sanitation)
```

```{r}
names(sanitation_raw)
```
### Rename Columns

```{r}
sanitation <- read_excel(file_path, sheet = "Sanitation",
                         skip = 2)

column_names <- c(
  "COUNTRY",
  "ISO3",
  "YEAR",
  "POPULATION(THOUSANDS)",
  "%URBAN",
  "NATIONAL_AtLeastBasic",
  "NATIONAL_Limited(shared)",
  "NATIONAL_Unimproved",
  "NATIONAL_OpenDefecation",
  "NATIONAL_AnnualRateOfChangeInBasic",
  "NATIONAL_AnnualRateOfChangeInOpenDefecation",
  "RURAL_AtLeastBasic",
  "RURAL_Limited(shared)",
  "RURAL_Unimproved",
  "RURAL_OpenDefecation",
  "RURAL_AnnualRateOfChangeInBasic",
  "RURAL_AnnualRateOfChangeInOpenDefecation",
  "URBAN_AtLeastBasic",
  "URBAN_Limited(shared)",
  "URBAN_Unimproved",
  "URBAN_Open defecation",
  "URBAN_AnnualRateOfChangeInBasic",
  "URBAN_AnnualRateOfChangeInOpenDefecation",
  "NATIONAL_SafelyManaged_Total",
  "NATIONAL_SafelyManaged_DisposedInSitu",
  "NATIONAL_SafelyManaged_EmptiedAndTreated",
  "NATIONAL_SafelyManaged_WastewaterTreated",
  "NATIONAL_SafelyManaged_TotalAnnualRateOfChange",
  "NATIONAL_FacilityType_LatrinesAndOthers",
  "NATIONAL_FacilityType_SepticTanks",
  "NATIONAL_FacilityType_SewerConnections",
  "RURAL_SafelyManaged_Total",
  "RURAL_SafelyManaged_DisposedInSitu",
  "RURAL_SafelyManaged_EmptiedAndTreated",
  "RURAL_SafelyManaged_WastewaterTreated",
  "RURAL_SafelyManaged_TotalAnnualRateOfChange",
  "RURAL_FacilityType_LatrinesAndOthers",
  "RURAL_FacilityType_SepticTanks",
  "RURAL_FacilityType_SewerConnections",
  "URBAN_SafelyManaged_Total",
  "URBAN_SafelyManaged_DisposedInSitu",
  "URBAN_SafelyManaged_EmptiedAndTreated",
  "URBAN_SafelyManaged_WastewaterTreated",
  "URBAN_SafelyManaged_TotalAnnualRateOfChange",
  "URBAN_FacilityType_LatrinesAndOthers",
  "URBAN_FacilityType_SepticTanks",
  "URBAN_FacilityType_SewerConnections",
  "SI",
  "SDGRegion", 
  "WHORegion", 
  "UNICEFProgrammingRegion", 
  "UNICEFReportingRegion"
)

sanitation <- sanitation %>% rename_with(~column_names)

sapply(sanitation, class)
```

```{r eval=FALSE}
column_names <- c(
  "COUNTRY",
  "ISO3",
  "YEAR",
  "POPULATION(THOUSANDS)",
  "%URBAN",
  "NATIONAL_AtLeastBasic",
  "NATIONAL_Limited(shared)",
  "NATIONAL_Unimproved",
  "NATIONAL_OpenDefecation",
  "NATIONAL_AnnualRateOfChangeInBasic",
  "NATIONAL_AnnualRateOfChangeInOpenDefecation",
  "RURAL_AtLeastBasic",
  "RURAL_Limited(shared)",
  "RURAL_Unimproved",
  "RURAL_OpenDefecation",
  "RURAL_AnnualRateOfChangeInBasic",
  "RURAL_AnnualRateOfChangeInOpenDefecation",
  "URBAN_AtLeastBasic",
  "URBAN_Limited(shared)",
  "URBAN_Unimproved",
  "URBAN_Open defecation",
  "URBAN_AnnualRateOfChangeInBasic",
  "URBAN_AnnualRateOfChangeInOpenDefecation",
  "NATIONAL_SafelyManaged_Total",
  "NATIONAL_SafelyManaged_DisposedInSitu",
  "NATIONAL_SafelyManaged_EmptiedAndTreated",
  "NATIONAL_SafelyManaged_WastewaterTreated",
  "NATIONAL_SafelyManaged_TotalAnnualRateOfChange",
  "NATIONAL_FacilityType_LatrinesAndOthers",
  "NATIONAL_FacilityType_SepticTanks",
  "NATIONAL_FacilityType_SewerConnections",
  "RURAL_SafelyManaged_Total",
  "RURAL_SafelyManaged_DisposedInSitu",
  "RURAL_SafelyManaged_EmptiedAndTreated",
  "RURAL_SafelyManaged_WastewaterTreated",
  "RURAL_SafelyManaged_TotalAnnualRateOfChange",
  "RURAL_FacilityType_LatrinesAndOthers",
  "RURAL_FacilityType_SepticTanks",
  "RURAL_FacilityType_SewerConnections",
  "URBAN_SafelyManaged_Total",
  "URBAN_SafelyManaged_DisposedInSitu",
  "URBAN_SafelyManaged_EmptiedAndTreated",
  "URBAN_SafelyManaged_WastewaterTreated",
  "URBAN_SafelyManaged_TotalAnnualRateOfChange",
  "URBAN_FacilityType_LatrinesAndOthers",
  "URBAN_FacilityType_SepticTanks",
  "URBAN_FacilityType_SewerConnections",
  "SI",
  "SDGRegion", 
  "WHORegion", 
  "UNICEFProgrammingRegion", 
  "UNICEFReportingRegion"
)

```

### Tidying data

```{r}
#tidying
sanitation <- sanitation %>% select(-SI) #remove indexing

#replace "-" with NA
sanitation <- sanitation %>% 
  mutate_all(~ifelse(. == "-", NA, .)) 

head(sanitation)
```

### Set as numeric

```{r}
#clean non numeric
#remove < and > on numbers column index 6 to 17
  #which one is better? Do this or set <1 as 0.5? 
#hygiene_data[, 6:17] <- lapply(hygiene_data[, 6:17], function(x)
#  as.numeric(gsub("\\>|<","", as.character(x)))) #or "[^[:alnum:]]" or "[^[0-9]]" 

# For now, "<1" is replaced with 0.5, and ">99" is replaced with 99.5
sanitation <- sanitation %>% 
  mutate_all(~ifelse(. == "<1", 0.5, .))

sanitation <- sanitation %>% 
  mutate_all(~ifelse(. == ">99", 99.5, .))

#set as numeric
sanitation <- sanitation %>%
  mutate_at(6:47, as.numeric)

sapply(sanitation, class)
```


### Divide to two df & Pivot Longer

Col 6:23 are one type of df, Col 24:47 are details of those df. So will separate into two df.

```{r}
### split into two df and pivot longer

#sanitation overview
sanitation1 <- sanitation %>%
  select(c(1:5, 6:23, 48:51)) %>%
  pivot_longer(
    cols = NATIONAL_AtLeastBasic:URBAN_AnnualRateOfChangeInOpenDefecation,
    names_to = c("REGION", "ServiceLevel"),
    names_sep = "_",
    values_to = "Percentage")

#sanitation details: Safely Managed Criteria and Facility Type
sanitation2 <- sanitation %>%
  select(c(1:5, 24:47, 48:51)) %>%
  pivot_longer(
    cols =  NATIONAL_SafelyManaged_Total:URBAN_FacilityType_SewerConnections,
    names_to = c("REGION", "ImprovedSanitationCriteria", "CriteriaDetails"),
    names_sep = "_",
    values_to = "Percentage")
```

```{r eval=FALSE}
names(sanitation1)
```
```{r eval=FALSE}
names(sanitation2)
```


Save df for future use (github)

```{r eval=FALSE}
#edit the sanitation 2 old file
#if want to write the df in folder
#write.csv(sanitation1, "C:/Users/jtanu/Documents/GitHub/DrinkingWater-Sanitation-Hygiene-Visualization/shinyApp/www/datasets/sanitation1.csv", row.names=FALSE)

#write.csv(sanitation2, "C:/Users/jtanu/Documents/GitHub/DrinkingWater-Sanitation-Hygiene-Visualization/shinyApp/www/datasets/sanitation2.csv", row.names=FALSE)
```

### Load files directly

```{r}
sanitation1 <- read_csv("C:/Users/jtanu/Documents/GitHub/DrinkingWater-Sanitation-Hygiene-Visualization/shinyApp/www/datasets/sanitation1.csv")

sanitation2 <- read_csv("C:/Users/jtanu/Documents/GitHub/DrinkingWater-Sanitation-Hygiene-Visualization/shinyApp/www/datasets/sanitation2.csv")
```

### QUESTION

How to pivot longer? Since it has two different type of data here. We have:

* `cols = NATIONAL_AtLeastBasic:URBAN_AnnualRateOfChangeInOpenDefecation` are called "Service Level" percentage
* `cols = NATIONAL_Exc-SafelyManaged:URBAN_Inc-SewerConnections` are called "Facility Type"

Split it into two df? 

### Donut Plot - Sanitation

World summary:

```{r}
unique(sanitation1$ServiceLevel)
```

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

sanitation1 %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           ServiceLevel != "AnnualRateOfChangeInOpenDefecation" &
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=ServiceLevel))+
    geom_text(aes(label = paste(round(median,2), " %")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
      # Set theme_void() to remove grid lines and everything else from the plot
    scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
    theme_void()
```

**Per country**

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

sanitation1 %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           ServiceLevel != "AnnualRateOfChangeInOpenDefecation" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           COUNTRY == "Indonesia" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=ServiceLevel))+
    geom_text(aes(label = paste(round(median,2), "%")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    theme_void()
```

**Per WHO Region**

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

sanitation1 %>% 
  filter(ServiceLevel != "AnnualRateOfChangeInBasic" & 
           ServiceLevel != "AnnualRateOfChangeInOpenDefecation" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           WHORegion == "South-East Asia" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(ServiceLevel) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=ServiceLevel))+
    geom_text(aes(label = paste(round(median,2), "%")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    theme_void()
```

### Lollipop for diverging and ranking

Diverging deviation for Annual Rate of Change in Basic:

```{r}
#per country
sanitation1 %>% 
  filter(ServiceLevel == "AnnualRateOfChangeInBasic" &  
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  arrange(desc(Percentage)) %>% #highest first 
  head(20) %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_segment(aes(xend=COUNTRY, yend=0)) +
    geom_point(size=6, color="chocolate1") +
    geom_text(aes(label=round(Percentage,1)), color="black", size=3)+
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %",
         title="Top 20 Countries")+
    coord_flip()
```

```{r}
#per country
sanitation1 %>% 
  filter(ServiceLevel == "AnnualRateOfChangeInBasic" & 
           YEAR == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  arrange(desc(Percentage)) %>% #highest first 
  tail(10) %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_segment(aes(xend=COUNTRY, yend=0)) +
    geom_point(size=6, color="chocolate1") +
    geom_text(aes(label=round(Percentage,2)), color="black", size=3)+
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %",
         title="Bottom 10 countries")+
    coord_flip()
```



---------------------------------------------------------------------------------
## HYGIENE

Definition:
Hygiene refers to the conditions and practices that help maintain health and prevent spread of disease including handwashing, food hygiene, and menstrual hygiene management (https://washdata.org/monitoring/hygiene).

```{r eval=FALSE}
hygiene_raw <- read_excel(file_path, sheet = "Hygiene") #.name_repair = "universal")

hygiene_raw
```

### Rename columns

```{r}
#rename column names
hygiene <- read_excel(file_path, sheet = "Hygiene")

#tidying
hygiene <- hygiene[-c(1),] #remove 2nd row (1st row in R)

column_names_hygiene <- c(
  "COUNTRY",
  "ISO3",
  "YEAR",
  "POPULATION(THOUSANDS)",
  "%URBAN",
  "NATIONAL_Basic",
  "NATIONAL_Limited(withoutWaterOrSoap)",
  "NATIONAL_NoFacility",
  "NATIONAL_AnnualRateOfChangeInBasic",
  "RURAL_Basic",
  "RURAL_Limited(withoutWaterOrSoap)",
  "RURAL_NoFacility",
  "RURAL_AnnualRateOfChangeInBasic",
  "URBAN_Basic",
  "URBAN_Limited(withoutWaterOrSoap)",
  "URBAN_NoFacility",
  "URBAN_AnnualRateOfChangeInBasic",
  "SI",
  "SDGRegion", 
  "WHORegion", 
  "UNICEFProgrammingRegion", 
  "UNICEFReportingRegion"
)

hygiene <- hygiene %>% rename_with(~column_names_hygiene)

sapply(hygiene, class)
```




###Tidying Data

```{r}
hygiene <- hygiene %>% select(-SI) #remove indexing

#replace "-" with NA
hygiene <- hygiene %>% mutate_all(~ifelse(. == "-", NA, .))

#head(hygiene)
```

### Set as numeric

```{r }
#clean non numeric
# For now, "<1" is replaced with 0.5, and ">99" is replaced with 99.5
hygiene <- hygiene %>% mutate_all(~ifelse(. == "<1", 0.5, .))
hygiene <- hygiene %>% mutate_all(~ifelse(. == ">99", 99.5, .))

hygiene <- hygiene %>%
  mutate_at(6:17, as.numeric)

sapply(hygiene, class)
```

### Pivot Longer 

```{r}
#Make dataset from wide to long, see R documentation (example shown below)
hygiene1 <- hygiene %>% 
  pivot_longer(
    cols = NATIONAL_Basic:URBAN_AnnualRateOfChangeInBasic,
    names_to = c("REGION", "ServiceLevel"),
    names_sep = "_",
    values_to = "Percentage")

head(hygiene1)
```

write to df:

```{r}
#if want to write the df in folder
#write.csv(hygiene1, "C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/hygiene1.csv", row.names=FALSE)
```

### Load files directly

```{r}
df_hygiene <- read_csv("C:/Users/jtanu/Documents/Northeastern/2023SPRING/IE6600/Assignment/FinalProject/hygiene1.csv")
```

#### WHO example

```{r eval=FALSE}
#from R documentation example:

#call dplyr dataset
who
```

```{r eval=False}
#check documentation example 

# Multiple variables stored in column names
who %>% pivot_longer(
  cols = new_sp_m014:newrel_f65,
  names_to = c("diagnosis", "gender", "age"),
  names_pattern = "new_?(.*)_(.)(.*)",
  values_to = "count"
)
```


### Preliminary Visualization

```{r}
hygiene_data2 %>% 
  filter(Area == "NATIONAL" & 
           COUNTRY == "Indonesia" &
           FacilityType =="Basic") %>% 
  ggplot(aes(x=Year, y=Percentage))+
    geom_col(aes(fill=Year)) + #aes(color=FacilityType))+
    theme_bw()
```

```{r}
#try bar chart for east & southern asia
hygiene_data2 %>% 
  filter(Area == "URBAN" & 
           SDGRegion == "Eastern and South-Eastern Asia" &
           FacilityType =="Basic") %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_col(aes(fill=Year))+ #it aggregate the year, so need to filter per year
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1))
```

```{r}
unique(hygiene_data2$FacilityType)
```


```{r}
hygiene_data2 %>% 
  filter(FacilityType != "AnnualRateOfChangeInBasic" & 
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(FacilityType, Year) %>% 
  summarise(mean = mean(Percentage)) %>% #sum=sum(Percentage*Population.thousands)
  ggplot(aes(x=Year, y=mean))+
    geom_col(aes(fill=FacilityType), position = "dodge")+
    labs(y="World population lacking basic sanitation") +
    theme_bw() #+
    #theme(axis.text.x = element_text(angle=30, hjust=1))
```

### Donut Plot - Hygiene

World summary:

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

hygiene_data2 %>% 
  filter(FacilityType != "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(FacilityType) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=FacilityType))+
    geom_text(aes(label = paste(round(median,2), " %")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
      # Set theme_void() to remove grid lines and everything else from the plot
    #scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
    theme_void() #+
    #theme(title="median World population % lacking basic sanitation")
    #labs(y="median World population % lacking basic sanitation") #+
```

Donut chart limit:
    If xlim left boundary is big, no empty circle. You get a pie chart
    If xlim is low, the ring becomes thinner.
    
Source: https://r-charts.com/part-whole/donut-chart-ggplot2/ 
https://r-graph-gallery.com/128-ring-or-donut-plot.html 

```{r}
hygiene_data2 %>% 
  filter(FacilityType != "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage))
```

**Per country**

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

hygiene_data2 %>% 
  filter(FacilityType != "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           COUNTRY == "Indonesia" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(FacilityType) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=FacilityType))+
    geom_text(aes(label = paste(round(median,2), "%")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    #scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    theme_void()
```

**Per Region**

```{r}
#set hole size to be the x axis so we can control the shape
hsize <- 3

hygiene_data2 %>% 
  filter(FacilityType != "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           WHORegion == "South-East Asia" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(FacilityType) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  ggplot(aes(x=hsize, y=median))+
    geom_col(aes(fill=FacilityType))+
    geom_text(aes(label = paste(round(median,2), "%")), #reduce decimal on value
            position = position_dodge(1)) +
    coord_polar(theta = "y")+ #convert bar chart to polar
      # Set the limits, which is important for adding the hole
    xlim(c(0.2, hsize + 0.5))+ #(c(2018.5, 2020.5)) +
    #scale_fill_brewer(palette = "GnBu") + #set color pallete per dataset
        # Set theme_void() to remove grid lines and everything else from the plot
    theme_void()
```


### Lollipop for rate of change or ranking - Hygiene

Diverging deviation for Annual Rate of Change in Basic:

```{r}
#per country
hygiene_data2 %>% 
  filter(FacilityType == "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  arrange(desc(Percentage)) %>% #highest first 
  head(20) %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_segment(aes(xend=COUNTRY, yend=0)) +
    geom_point(size=6, color="lightgreen") +
    geom_text(aes(label=round(Percentage,1)), color="black", size=3)+
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %")+
    coord_flip()
```

```{r}
#per country
hygiene_data2 %>% 
  filter(FacilityType == "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  arrange(desc(Percentage)) %>% #highest first 
  tail(10) %>% 
  ggplot(aes(x=COUNTRY, y=Percentage))+
    geom_segment(aes(xend=COUNTRY, yend=0)) +
    geom_point(size=6, color="lightgreen") +
    geom_text(aes(label=round(Percentage,2)), color="black", size=3)+
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %")+
    coord_flip()
```

source: https://r-graph-gallery.com/302-lollipop-chart-with-conditional-color.html 
https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html


Per region

```{r}
hygiene_data2 %>% 
  filter(FacilityType == "AnnualRateOfChangeInBasic" & 
           Year == 2020 &
           REGION == "NATIONAL" &
           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
  group_by(WHORegion) %>% #combine all country
  summarise(median = median(Percentage)) %>% 
  arrange(desc(median)) %>% #highest first 
  ggplot(aes(x=WHORegion, y=median))+
    geom_segment(aes(xend=WHORegion, yend=0)) +
    geom_point(size=4, color="lightgreen") +
    theme_bw() +
    labs(x="", y="median AnnualRateOfChangeInBasic %")+
    coord_flip()
```


**Ranking?? (TBD)**

```{r eval=FALSE}
#hygiene_data2 %>% 
#  filter(FacilityType != "AnnualRateOfChangeInBasic" & 
#           Year == 2020 &
#           REGION == "NATIONAL" &
#           !is.na(Percentage)) %>% #remove NA to prepare for calculation below
#  group_by(FacilityType, Year) %>% #combine all country
#  summarise(median = median(Percentage)) %>% 
#  ggplot(aes(x=hsize, y=median))+
```

##Forecast

source: https://towardsdatascience.com/a-guide-to-forecasting-in-r-6b0c9638c261 

No seasonal or cyclic pattern, so choose: Exponential smoothing

```{r}
#install.packages("forecast")
library(forecast)
```

```{r}
library(forecast)

df_forecast <- df_water %>%
    filter(REGION == "NATIONAL" &
             ServiceLevel != "AnnualRateOfChangeInBasic") %>%
    mutate(Total_Population = `POPULATION(THOUSANDS)` * Percentage 
           / 100 / 1000) %>%
    group_by(YEAR, ServiceLevel) %>%
    summarise(`POPULATION(MILLIONS)` = sum(`Total_Population`, na.rm=TRUE)) %>% 
    ungroup()

ggplot(data = df_forecast, aes(x=YEAR, y=`POPULATION(MILLIONS)`,
                             group=ServiceLevel, color=ServiceLevel)) +
    geom_line() +
    geom_point() +
    theme_bw()
```

```{r}
class(df_forecast)  
```


```{r}
df_forecast_wide <- df_forecast %>% 
  pivot_wider(names_from = ServiceLevel, 
              values_from = `POPULATION(MILLIONS)`)
```


### Convert df to ts

source: https://www.statology.org/r-convert-data-frame-to-time-series/ 

```{r fig.height=11}
df_forecast_basic <- df_forecast %>% 
  filter(ServiceLevel == "AtLeastBasic") %>% 
  select(!ServiceLevel)

class(df_forecast_basic)
```

```{r}
library(zoo)
tseries <- read.zoo(df_forecast_basic)

tseries 
```

```{r}
class(tseries)
```

```{r}
#convert to ts object
tseries_ts <- as.ts(tseries)

#view time series object
tseries_ts

#view class
class(tseries_ts)
```

**convert all dataset to ts**

```{r}
#convert to timeseries with multiple variables
tseries_dw <-read.zoo(df_forecast_wide)
class(tseries_dw)

tseries_dw_ts <- as.ts(df_forecast_wide)
class(tseries_dw_ts)
#why doesnt keep multiple var?
```
https://stackoverflow.com/questions/29046311/how-to-convert-dataframe-into-time-series

```{r}
Canada
```


```{r}
tseries_dw_ts
```


### TS decomposition

source: https://www.simplilearn.com/tutorials/data-science-tutorial/time-series-forecasting-in-r 

```{r}
#create time series decomposition with frequecy = 5 years
tsdata_basic <- ts(tseries_ts, frequency = 5) 
ddata_basic <- decompose(tsdata_basic, "additive") #predicted to be additive (verified)
plot(ddata_basic)
```

Obvious increasing trend as expected. There is seasonal trend if we see the graph but the y-scale is actually only 0.005 range! Therefore, no obvious seasonal or random trend.

**Plot individually** 

We see increasing trend about 1.5 billion people in 5 years. Less steep recently.

```{r}
plot(ddata_basic$trend)
```


```{r}
plot(tseries_ts)
abline(reg=lm(tseries_ts~time(tseries_ts)), 
       col = "blue")
```

**Create box plot to check cycle**

No cyclic trend found.

```{r}
boxplot(tseries_ts~cycle(tseries_ts))#, 
                         # xlab="Year", ylab = "Population (millions)", 
                         # main = "Drinkin Water At least basic service level between 2000-2020"))
```

### Exponential Smoothing

Use state space model, source: https://towardsdatascience.com/a-guide-to-forecasting-in-r-6b0c9638c261 

```{r}
#Create samples
training=window(tseries_ts, start = 2000, end = 2015)
validation=window(tseries_ts, start = 2016)
```

```{r eval=FALSE}
training
```

```{r}
ets_model = ets(training, allow.multiplicative.trend = TRUE)
summary(ets_model)
```
ETS(A,A,N) means the exponential smoothing model (ETS) has:

* error type "A" = additive
* trend type "A" = additive
* season type "N" = none.

As predicted before, the dataset only have additive trend with no seasonality. 

source: https://www.rdocumentation.org/packages/forecast/versions/8.21/topics/ets 

```{r}
library(ModelMetrics)
ets_forecast = forecast(ets_model, h=length(validation))

paste("Validation RMSE: ", round(rmse(validation, ets_forecast$mean),2))
```
RMSE is not too bad considering mean are mainly in thousands.

```{r}
plot(ets_forecast, xlab="Year", ylab="Population(millions)")
```

```{r}

```

```{r}

```


```{r}
summary(ets_forecast)
```


### ARIMA

```{r}
model_arima <- auto.arima(tseries_ts)

model_arima
```
```{r}
#plot residuals
plot.ts(model_arima$residuals)
```

```{r}
#forecast for 10 years to see if the 2030 goal is achieved
dwforecast <- forecast(model_arima, #use arima to include everything
                       level=c(95), #set CI = 95%
                       h=10) #10 years

plot(dwforecast)
```

Validate the Model by Selecting Lag Values

```{r}
Box.test(model_arima$resid, lag=10, type="Ljung-Box")
```

#### Plotting in ggfortify

source: https://cran.r-project.org/web/packages/ggfortify/vignettes/plot_ts.html 

```{r}
#install.packages("ggfortify")
#install.packages("vars")
```


```{r}
library(ggfortify)
autoplot(tseries_ts)+
  theme_bw()+
  labs(x="YEAR", y ="Population(millions)")
```

```{r}
#plot in ggplot using ggfortify
autoplot(dwforecast, predict.colour = 'blue',
         predict.linetype = 'dotdash', predict.size = 1,
         conf.int = TRUE, label=TRUE)+
  # geom_text(aes(y=model_arima$mean))+
  # annotate("text", label = paste("Population in 2023 :", 
  #                                round(dwforecast$mean[10]/1000, 2)),
  #          x = 2030, y = 8000, color = "blue")
  theme_bw()+
  labs(title="Total population with 'at least basic' drinking water service",
       subtitle= paste("2030's total population with 'at least basic' ARIMA prediction=",
                       round(dwforecast$mean[10]/1000, 2), "millions"),
       x="YEAR", y ="Population(millions)")
```

```{r}
ggtsdiag(model_arima)
```
source:
https://rpubs.com/sinhrks/plot_tsstats 
https://rpubs.com/sinhrks/plot_ts
https://rpubs.com/sinhrks/basics


```{r}
tseries_ts %>% 
  decompose(type ="additive") %>% 
  autoplot()
```

```{r}
round(dwforecast$mean[10]/1000, 2)
```

#### using vars

```{r}
library(vars)
autoplot(tseries_dw_ts)
```

```{r}
tseries_dw
```


# Question

* how to filter top and bottom rows in the same pipe?
* how to put the chosen year in the subtitle of the plot? Do we need this?
